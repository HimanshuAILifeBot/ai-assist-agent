<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            font-family: sans-serif;
            margin: 0;
            display: flex;
        }
        .sidebar {
            width: 250px;
            background-color: #2c2c2c;
            height: 100vh;
            padding: 20px;
        }
        .sidebar h2 {
            color: #f0f0f0;
            text-align: center;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }
        .sidebar ul li {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }
        .sidebar ul li:hover {
            background-color: #444;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            display: none;
        }
        .main-content.active {
            display: flex;
        }
        .left-column {
            width: 30%;
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            margin-right: 20px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
        .right-column {
            width: 70%;
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
        .date-list ul, .user-list ul, .ticket-list ul {
            list-style-type: none;
            padding: 0;
        }
        .date-list-item, .ticket-list-item {
            padding: 10px;
            cursor: pointer;
        }
        .date-list-item:hover, .ticket-list-item:hover {
            background-color: #444;
        }
        .user-list-item {
            padding: 10px;
            cursor: pointer;
            padding-left: 20px;
        }
        .user-list-item:hover {
            background-color: #444;
        }
        .conversation {
            margin-top: 20px;
        }
        .message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .user-message {
            background-color: #444;
        }
        .bot-message {
            background-color: #555;
        }
        .upload-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .upload-btn {
            width: 100px;
            height: 100px;
            background-color: #444;
            border: 2px dashed #888;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 50px;
        }
        .upload-btn:hover {
            background-color: #555;
        }
        #document-list {
            margin-top: 20px;
        }
        .document-item {
            background-color: #444;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Admin Panel</h2>
        <ul>
            <li id="inbox-btn">Inbox</li>
            <li id="knowledge-base-btn">Knowledge Base</li>
            <li id="query-tickets-btn">Query Tickets</li>
        </ul>
    </div>
    <div class="main-content active" id="inbox-view">
        <div class="left-column">
            <h3>Inbox</h3>
            <div id="date-list"></div>
        </div>
        <div class="right-column">
            <h3>Conversation</h3>
            <div id="conversation"></div>
        </div>
    </div>

    <div class="main-content" id="knowledge-base-view">
        <div class="right-column" style="width: 100%">
            <h3>Knowledge Base</h3>
            <div id="document-list"></div>
            <div class="upload-container">
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div class="upload-btn" id="upload-btn">+</div>
                    <span style="color: #f0f0f0; margin-top: 10px;">Add Knowledge Base</span>
                </div>
                <input type="file" id="file-input" style="display: none;" accept=".pdf,.txt">
            </div>
        </div>
    </div>

    <div class="main-content" id="query-tickets-view">
        <div class="left-column">
            <h3>Query Tickets</h3>
            <div id="ticket-list"></div>
        </div>
        <div class="right-column">
            <h3>Ticket Details</h3>
            <div id="ticket-details"></div>
        </div>
    </div>

    <script>
        const inboxView = document.getElementById('inbox-view');
        const knowledgeBaseView = document.getElementById('knowledge-base-view');
        const queryTicketsView = document.getElementById('query-tickets-view');

        const inboxBtn = document.getElementById('inbox-btn');
        const knowledgeBaseBtn = document.getElementById('knowledge-base-btn');
        const queryTicketsBtn = document.getElementById('query-tickets-btn');

        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const documentList = document.getElementById('document-list');

        function switchView(view) {
            inboxView.classList.remove('active');
            knowledgeBaseView.classList.remove('active');
            queryTicketsView.classList.remove('active');
            document.getElementById(view).classList.add('active');
        }

        inboxBtn.addEventListener('click', () => switchView('inbox-view'));
        knowledgeBaseBtn.addEventListener('click', () => {
            switchView('knowledge-base-view');
            loadDocuments();
        });
        queryTicketsBtn.addEventListener('click', () => {
            switchView('query-tickets-view');
            loadTickets();
        });

        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);

                fetch('/admin/upload-document', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadDocuments();
                    } else {
                        alert('File upload failed');
                    }
                });
            }
        });

        function loadDocuments() {
            fetch('/admin/get-documents')
                .then(response => response.json())
                .then(documents => {
                    documentList.innerHTML = '';
                    documents.forEach(doc => {
                        const docElement = document.createElement('div');
                        docElement.classList.add('document-item');
                        docElement.textContent = doc;
                        documentList.appendChild(docElement);
                    });
                });
        }

        document.getElementById('inbox-btn').addEventListener('click', () => {
            fetch('/admin/inbox/dates')
                .then(response => response.json())
                .then(dates => {
                    const dateList = document.getElementById('date-list');
                    dateList.innerHTML = '';
                    dates.forEach(date => {
                        const dateDiv = document.createElement('div');
                        dateDiv.classList.add('date-list-item');
                        dateDiv.innerHTML = `<h4>${date}</h4>`;
                        const userList = document.createElement('ul');
                        dateDiv.appendChild(userList);
                        dateList.appendChild(dateDiv);

                        dateDiv.addEventListener('click', () => {
                            fetch(`/admin/inbox/users?date=${date}`)
                                .then(response => response.json())
                                .then(users => {
                                    userList.innerHTML = '';
                                    users.forEach(user => {
                                        const userLi = document.createElement('li');
                                        userLi.classList.add('user-list-item');
                                        userLi.textContent = user.email;
                                        userLi.addEventListener('click', (event) => {
                                            event.stopPropagation();
                                            fetch(`/admin/inbox/conversations?user_id=${user.id}&date=${date}`)
                                                .then(response => response.json())
                                                .then(conversations => {
                                                    const conversationDiv = document.getElementById('conversation');
                                                    conversationDiv.innerHTML = '';
                                                    conversations.forEach(conv => {
                                                        const userMsg = document.createElement('div');
                                                        userMsg.classList.add('message', 'user-message');
                                                        userMsg.textContent = `User: ${conv.interaction.question}`;
                                                        const botMsg = document.createElement('div');
                                                        botMsg.classList.add('message', 'bot-message');
                                                        botMsg.textContent = `Bot: ${conv.interaction.answer}`;
                                                        conversationDiv.appendChild(userMsg);
                                                        conversationDiv.appendChild(botMsg);
                                                    });
                                                });
                                        });
                                        userList.appendChild(userLi);
                                    });
                                });
                        });
                    });
                });
        });

        function loadTickets() {
            const token = localStorage.getItem('adminAuthToken'); // Assuming admin token is stored
            fetch('/admin/tickets', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => response.json())
                .then(tickets => {
                    const ticketList = document.getElementById('ticket-list');
                    ticketList.innerHTML = '';
                    tickets.forEach(ticket => {
                        const ticketDiv = document.createElement('div');
                        ticketDiv.classList.add('ticket-list-item');
                        ticketDiv.innerHTML = `<h4>TICKET-${String(ticket.id).padStart(3, '0')}</h4><p>${ticket.topic}</p>`;
                        ticketDiv.addEventListener('click', () => loadTicketDetails(ticket.id));
                        ticketList.appendChild(ticketDiv);
                    });
                });
        }

        function loadTicketDetails(ticketId) {
            const token = localStorage.getItem('adminAuthToken'); // Assuming admin token is stored
            fetch(`/admin/tickets/${ticketId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => response.json())
                .then(data => {
                    const ticketDetails = document.getElementById('ticket-details');
                    const user = data.user;
                    const ticket = data.ticket;
                    ticketDetails.innerHTML = `
                        <h4>TICKET-${String(ticket.id).padStart(3, '0')}</h4>
                        <p><strong>User:</strong> ${user.email}</p>
                        <p><strong>Phone:</strong> ${user.phone_number || 'N/A'}</p>
                        <p><strong>Topic:</strong> ${ticket.topic}</p>
                        <p><strong>Status:</strong> ${ticket.status}</p>
                        <p><strong>Created:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
                    `;
                });
        }

    </script>
</body>
</html>